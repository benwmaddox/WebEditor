<html>

<head>
    <style>
        textarea {
            white-space: pre-wrap;
            word-wrap: break-word;
            display: block;
            resize: none;
            overflow: hidden;
            width: 120ch;
            margin-top: 8px;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="codemirror.css" />
    <script src="codemirror.js"></script>
</head>

<body>
    Editor
    <pre>
        alt-n               New editor
        alt-Up              Navigate up an editor
        alt-Down            Navigate down an editor        
        alt-shift-Up        Move an editor up
        alt-shift-Down      Move an editor down
        alt-W               Close an editor
        alt-Enter           Run code in editor
        alt-s               Save whole file
    </pre>

    <div id="editors"></div>
    <div id="library">
        <script type="text/javascript" id="Core.namespace">
            var Functions = {};

            function namespace(namespacePath, fn) {
                // TODO: stick into Functions variable
                var pathSplits = namespacePath.split('.');

                return fn;
            }
            namespace('Core', namespace);
        </script>
        <script type="text/javascript" id="Core.getFunctionScripts">
            function getFunctionScripts() {
                return Array.from(document.querySelectorAll('script[id]'));
            }
            namespace('Core', getFunctionScripts);
        </script>
        <script type="text/javascript" id="Core.extractFunctionDetail">
            function extractFunctionDetail(element) {
                return {
                    id: element.id,
                    content: element.innerHTML
                };
            }
            namespace('Core', extractFunctionDetail);
        </script>
    </div>
    <script type="text/javascript">
        var fileHandle = null;
        async function pickFile() {
            // open file picker
            [fileHandle] = await window.showSaveFilePicker();
            if (fileHandle.kind === 'file') {
                // run file code

            } else if (fileHandle.kind === 'directory') {
                // run directory code
            }
            return fileHandle;

        }
        async function writeToFileHandle(handle, content) {
            const writableStream = await handle.createWritable();
            await writableStream.write(imgBlob);
            await writableStream.close();
        }
        // Function to download data to a file
        async function download(data, filename, type) {
            var handle = fileHandle || await pickFile();

            var file = new Blob([data], { type: type });

            if (fileHandle) {
                writeToFileHandle(handle, data);
                debugger;
                return;
            }
            debugger;

            if (window.navigator.msSaveOrOpenBlob) // IE10+
                window.navigator.msSaveOrOpenBlob(file, filename);
            else { // Others
                var a = document.createElement("a"),
                    url = URL.createObjectURL(file);
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(function () {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }
        }
        namespace('Core.IO', download);
        document.addEventListener('keyup', (keyEvent) => {
            if (keyEvent.altKey && keyEvent.key === "n") {
                // var newEditor = document.createElement('textarea');
                // var a = document.getElementById('editors').appendChild(newEditor);
                // var editor = CodeMirror.fromTextArea(newEditor, {
                //     lineNumbers: true,
                //     mode: "javascript"
                // });
                // editor.focus();
                // debugger;
                var a = document.getElementById('editors').appendChild(document.createElement('textarea'));
                a.focus();
            }
            else if (keyEvent.altKey && keyEvent.shiftKey && keyEvent.key === "ArrowUp") {
                var activeElement = document.activeElement;
                activeElement.parentElement.insertBefore(activeElement, activeElement.previousSibling);
                activeElement.focus();
            }
            else if (keyEvent.altKey && keyEvent.shiftKey && keyEvent.key === "ArrowDown") {
                var activeElement = document.activeElement;
                activeElement.parentElement.insertBefore(activeElement.nextSibling, activeElement);
                activeElement.focus();
            }
            else if (keyEvent.altKey && keyEvent.key === "ArrowUp") {
                document.activeElement.previousSibling.focus();
            }
            else if (keyEvent.altKey && keyEvent.key === "ArrowDown") {
                document.activeElement.nextSibling.focus();
            }

            else if (keyEvent.altKey && keyEvent.key === "o") {
                pickFile();
            }
            else if (keyEvent.altKey && keyEvent.key === "s") {
                //https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API#browser_compatibility
                //$0.setAttribute('value', $0.value);
                //document.body.innerHTML

                // Export as an html file. The whole thing.
                // var blob = new Blob(document.body.innerHTML, { type: "text/html;charset=utf-8" })
                // saveas

                // Note that closing tags are split up because I don't really want to end the html document
                var html = '<html><head>' + document.head.innerHTML + '<' + '/head><body>' + document.body.innerHTML + '<' + '/body><' + '/html>';
                download(html, "index3.html", "text/html;charset=utf-8");


            }
            else if (keyEvent.altKey && keyEvent.key === "w") {

                var nextFocus = null;
                // Handle null;                
                var nextFocus = document.activeElement.previousSibling;
                if (!nextFocus || nextFocus.nodeName != "TEXTAREA") {
                    nextFocus = document.activeElement.nextSibling;
                }
                if (nextFocus.nodeName != "TEXTAREA") {
                    nextFocus = null;
                }
                document.activeElement.parentElement.removeChild(document.activeElement);
                if (nextFocus) nextFocus.focus();
            }
            else if (keyEvent.altKey && keyEvent.key == "Enter") {
                try {

                    // var result = eval(document.activeElement.value);
                    // runningCode.appendChild
                    // var fn = new Function(document.activeElement.value);
                    // var result = fn();
                    var oScript = document.createElement("script");
                    // document.activeElement.save();
                    var oScriptText = document.createTextNode(document.activeElement.value);
                    console.log(oScriptText);
                    oScript.appendChild(oScriptText);
                    document.getElementById("library").appendChild(oScript);
                    var result = eval(document.activeElement.value);
                    // todo: better function behavior?

                    // var fn = new Function(document.activeElement.value);
                    // debugger;
                }
                catch (error) {
                    var result = error;
                }
                document.getElementById('output').innerText = result || '';
            }
        });
        document.addEventListener('keydown', (event) => {
            event.srcElement.style.height = "auto";
            event.srcElement.style.height = (event.srcElement.scrollHeight + 15) + "px";
        });

    </script>
    <div id="output"></div>
</body>

</html>